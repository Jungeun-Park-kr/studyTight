<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script> 

    <title>회원가입</title>
    
    <style>
        @import url(/public/login/login.css);
        @import url(/public/font.css); 
        @import url(/public/login/register.css);
        @import url(/public/login/register_modal.css); 
        @import url(/public/login/register_agree.css);
    </style>
    
</head>
<body>
    <div id="warp">
        <div class="register_header"> 
            <!-- 여기는 왼쪽 메뉴 (로고) -->
            <div class ="logo_area"> 
                <img src="/public/media/logo_big.png" onclick="location.href='/'">
            </div>
        </div>
        <div id="container" role="main">
            <div class="section">
                <!-- 여기는 본문 들어갈 메인 섹션 -->
                
                <div class="join_section">
                    <!-- <form id="join_form" method="POST"> -->
                    <!-- <form id="join_form"> -->
                        <div class="join_content">
                            <!-- 이메일 영역 -->
                            <div class="join_row join_email" id="emilDiv">
                                <div class="join_label">이메일</div>
                                <div class="email_verify_area">
                                
                                        <span class="join_form">
                                            <input type="email" id="email" name="email" placeholder="이메일 입력" maxlength="30"/>
                                        </span>

                                        <a  class="btn_verify btn_primary" id="btn_email_send" role='button'>
                                            <span class="send_verify">인증번호 받기</span>
                                        </a>
                                        <script>
                                            // const send_verify_btn = document.querySelector('send_verify');
                                            // $.post('/email', function(data){
                                            //     console.log(data);
                                            // });
                                        </script>
                                    
                                </div>
                                <!-- 인증번호 입력 영역 -->
                                <div class="email_verify_area">
                                    
                                    <span class="join_form" >
                                        <input type="tel" id="email_verify" name="email_verify" placeholder="인증번호 입력" maxlength="6" disabled='true'/>
                                    </span>
                                    <a href="#" class="btn_verify btn_primary" id="btn_email_verify" role="button">
                                        <span class="chk_verify">인증번호 확인</span>
                                    </a>
                                </div>
                                <div class="verify_fail_info">인증번호를 받지 못하셨나요?</div>
                            </div>
                            <!-- 비밀번호 영역 -->
                            <div class="join_row join_pw" id="pwDiv">
                                <div class="join_label">비밀번호</div>
                                <div class="pw_input_area">
                                    <span class="join_form">
                                        <input type="password" id="password" name="password" placeholder="비밀번호 (6자리 ~ 32자리)" maxlength="32" minlength="6"/>
                                    </span>
                                </div>
                                <div class="pw_verify_area">
                                    <span class="join_form">
                                        <input type="password" id="password_verify" name="password_verify" placeholder="비밀번호 재확인" maxlength="32" minlength="6"/>
                                    </span>

                                    <a href="#" class="btn_verify btn_primary" id="btn_password_verify" role="button">
                                        <span class="password_verify">비밀번호 확인</span>
                                    </a>
                                </div>
                            </div>


                            <!--  개인정보 입력 영역  -->
                            <!-- 이름 영역 -->
                            <div class="join_row join_name" id="infoDiv">
                                <div class="join_label">이름</div>
                                <div class="name_input_area">
                                    <span class="join_form">
                                        <input type="text" id="name" name="name" title="이름" class="int" placeholder="타인에게 공개될 내 이름 입력" maxlength="40" >
                                    </span>
                                </div>
                            </div>
                            
                            <!-- 성별 영역 -->
                            <div class="join_row join_gender" id="genderDiv">
                                <div class="join_label">성별</div>
                                <div class="gender_input_area">
                                    <div class="gender_code">
                                        <select id="gender" name="gender" class="sel">
                                            <option value selected>성별</option>
                                            <option value="M">남자</option>
                                            <option value="F">여자</option>
                                            <option value="U">선택 안함</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="join_row join_birth" id="birthDiv">
                                <!-- 생년월일 영역 -->
                                <div class="join_label">생년월일</div>
                                <div class="bir_wrap">
                                    <div class="bir_yy">
                                        <span class="join_form">
                                            <input type="text" id="yy" placeholder="년(4자)" aria-label="년(4자)" class="int" maxlength="4">
                                        </span>
                                    </div>
                                    <div class="bir_mm">
                                        <div class="month_code">
                                            <select id="mm" class="sel" aria-label="월">
                                                <option value="">월</option>
                                                                <option value="01">
                                                                    1
                                                                </option>
                                                                <option value="02">
                                                                    2
                                                                </option>
                                                                <option value="03">
                                                                    3
                                                                </option>
                                                                <option value="04">
                                                                    4
                                                                </option>
                                                                <option value="05">
                                                                    5
                                                                </option>
                                                                <option value="06">
                                                                    6
                                                                </option>
                                                                <option value="07">
                                                                    7
                                                                </option>
                                                                <option value="08">
                                                                    8
                                                                </option>
                                                                <option value="09">
                                                                    9
                                                                </option>
                                                                <option value="10">
                                                                    10
                                                                </option>
                                                                <option value="11">
                                                                    11
                                                                </option>
                                                                <option value="12">
                                                                    12
                                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="bir_dd">
                                        <span class="join_form">
                                            <input type="text" id="dd" placeholder="일" aria-label="일" class="int" maxlength="2">
                                            <label for="dd" class="lbl"></label>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- 가입하기 버튼 -->
                            <div class="btn_area">
                                <button id="btnJoin" class="btn_type btn_primary"><span class="register">가입하기</span></button>
                                <!-- <button id="btnJoin" class="btn_type btn_primary" formaction="/signup" ><span class="register">가입하기</span></button> -->
                            </div>
                        </div>
                    <!-- </form> -->
                </div>
            </div>
        
        </div>


        <!-- 팝업 될 레이어 -->
        <div id="modal" class="modal modal_fail">
            <div class="modal-content">
                <span class="close_button close_fail_button">&times;</span>
                <h1 class="title">인증번호를 받지 못하셨나요?</h1>

                <!-- 내용 띄울 부분 -->
                <div class="content">이메일이 정확한지 확인해주세요. 
                    현재 사용중인 네이버, 구글, 다음(카카오)등의 메일이 맞나요?
                    사이트에 따라 인증번호 발송이 늦어질 수 있습니다.
                    계속해서 메일이 오지 않으면, 다시 인증번호를 요청해주세요.</div>

                <!-- 확인 버튼 -->
                <input type="button" id="confirm_fail" class="btn_confirm" value="확인"> 
            </div>
        </div>
        <div id="modal" class="modal modal_send">
            <div class="modal-content-small">
                <span class="close_button close_send_button">&times;</span>
                <h1 class="title">인증번호 발신 성공</h1>

                <!-- 내용 띄울 부분 -->
                <div class="content">입력한 이메일 계정에 접속하여
                    메일에 있는 인증번호를 입력 후,
                    인증번호 확인을 해주세요.</div>

                <!-- 확인 버튼 -->
                <input type="button" id="confirm_send" class="btn_confirm" value="확인" > 
                
                
            </div>
        </div>
        <div id="modal" class="modal modal_check">
            <div class="modal-content-small">
                <span class="close_button close_check_button">&times;</span>
                <h1 class="title">인증번호 확인 성공</h1>

                <!-- 내용 띄울 부분 -->
                <div class="content">이메일을 꼭 기억해주세요.
                    분실시 찾을 수 없으며,
                    비밀번호 찾기에 이용됩니다.
                    계속해서 나머지 정보를 입력해주세요.</div>

                <!-- 확인 버튼 -->
                <input type="button" id="confirm_check" class="btn_confirm" value="확인"> 
            </div>
        </div>
        <div id="modal" class="modal modal_password">
            <div class="modal-content-small">
                <span class="close_button close_password_button">&times;</span>
                <h1 class="title">비밀번호 확인</h1>

                <!-- 내용 띄울 부분 -->
                <div class="content">
                    비밀번호 확인이 완료 되었습니다.
                </div>

                <!-- 확인 버튼 -->
                <input type="button" id="confirm_password" class="btn_confirm" value="확인"> 
            </div>
        </div>
        <div id="modal" class="modal modal_register">
            <div class="modal-content-small">
                <span class="close_button close_register_button">&times;</span>
                <h1 class="title">회원가입 완료</h1>
                <!-- 내용 띄울 부분 -->
                <div class="content">회원가입을 축하드립니다!
                    이제 study Tight 서비스를 
                    이용할 수 있습니다.
                    가입시 입력한 이메일을 꼭 기억해 주세요.</div>
                <!-- 확인 버튼 -->
                <input type="submit" id="confirm_register" class="btn_confirm" value="확인"> 
            </div>
        </div>
        <script type="text/javascript">
            // $(document).ready(function() {
            //     // 인증번호 전송 버튼
            //     $('#btn_email_send').click(function() {
            //         var email = $('#email').val(); // 입력받은 이메일
            //         var inputBox = $('#email_verify'); // 인증번호 입력란
            //         var verifyBtn = $('#btn_email_verify'); //인증번호 확인 버튼
                    
            //         // 이메일 전송
            //         $.ajax({
            //             type:"POST",
            //             async : true,
            //             url:'/email',
            //             data : {
            //                 email: email,
            //             },
            //             success:function( authNum ){ // 이메일 전송 성공한 경우
            //                 console.log('인증번호 전송 성공');
            //                 // 이메일 전송 성공 팝업 띄우기



            //                 console.log("authNum : " + authNum);
            //                 inputBox.removeAttr('disabled'); // disabled 속성 삭제
            //             }, 
            //             error: function(err) { // POST 요청 실패시
            //                 console.log('인증번호 보내기 실패' + err);
            //             }
                                
            //         });


                    
            //     });
            // });

        </script>


        <script type="text/javascript">
        $(document).ready(function() {
            var modal_fail = document.querySelector(".modal_fail"); // 팝업 될 레이어 class명
            var modal_send = document.querySelector(".modal_send");
            var modal_check = document.querySelector(".modal_check");
            var modal_register = document.querySelector(".modal_register"); 
            var modal_password = document.querySelector(".modal_password");
            
            var trigger_verify_fail = document.querySelector(".verify_fail_info"); // 인증번호 받기 실패 안내 버튼
            var trigger_send_verify = document.querySelector(".send_verify"); // 인증번호 받기 버튼
            var trigger_chk_verify = document.querySelector(".chk_verify"); // 인증번호 확인 버튼
            var trigger_register = document.querySelector(".register"); // 가입하기 버튼
            var trigger_password = document.querySelector(".password_verify"); // 비밀번호 확인 버튼
            
            var closeFailButton = document.querySelector(".close_fail_button"); // 우측 상단 닫기 버튼
            var closeSendButton = document.querySelector(".close_send_button");
            var closeCheckButton = document.querySelector(".close_check_button");
            var closeRegisterButton = document.querySelector(".close_register_button");
            var closePasswordButton = document.querySelector(".close_password_button");

            var confirmFailButton = document.querySelector("#confirm_fail"); // <- 확인 버튼 (취소 버튼 용으로 씀)
            var confirmSendButton = document.querySelector("#confirm_send");
            var confirmCheckButton = document.querySelector("#confirm_check");
            var confirmRegisterButton = document.querySelector("#confirm_register");
            var confirmPasswordButton = document.querySelector("#confirm_password");

            var authNum; // 인증번호
            var isAuthChecked = false;
            var isPassChecked = false;
            
        
            function toggleFailModal() {
                modal_fail.classList.toggle("show_modal");
                
            }
            function toggleSendModal() {
                modal_send.classList.toggle("show_modal");
            }
            function toggleCheckModal() {
                modal_check.classList.toggle("show_modal");
            }
            function toggleRegisterModal() {
                modal_register.classList.toggle("show_modal");
            }
            function togglePasswordModal() {
                modal_password.classList.toggle("show_modal");
            }
        
            function windowOnClick(event) {
                if (event.target === modal_fail) {
                    toggleFailModal();
                }
                else if (event.target === modal_send) {
                    toggleSendModal();
                } else if (event.target === modal_check) {
                    toggleCheckModal();
                    
                } else if (event.target === modal_password) {
                    togglePasswordModal();
                }
            }

            function sendAuthEmail(event) {
                var email = $('#email').val(); // 입력받은 이메일
                var inputBox = $('#email_verify'); // 인증번호 입력란
                var verifyBtn = $('#btn_email_verify'); //인증번호 확인 버튼
                
                // 이메일 전송
                $.ajax({
                    type:"POST",
                    async : true,
                    url:'/email',
                    data : {
                        email: email,
                    },
                    success:function( data ){ // 이메일 전송 성공한 경우
                        if (data === 'email_error=exist') { // 중복 이메일
                            alert('이미 가입된 이메일입니다.');
                        } else {
                            console.log('인증번호 전송 성공');
                            toggleSendModal(); // 이메일 전송 성공 팝업 띄우기

                            authNum = data;
                            console.log("authNum : " + data);
                            inputBox.removeAttr('disabled'); // disabled 속성 삭제
                        }

                    }, 
                    error: function(err) { // POST 요청 실패시
                        
                        console.log('인증번호 보내기 실패');
                        console.log(err);
                        alert('올바르지 않은 이메일입니다.\n확인 후 다시 시도해주세요.')
                    }
                });
            }

            function emailCheck(event) {
                //console.log('인증번호 확인');
                if ( $('#email_verify').val() == authNum) {
                    console.log('인증번호 확인 성공');
                    isAuthChecked = true;
                    toggleCheckModal();
                } else {
                    alert('인증번호가 일치하지 않습니다.\n다시한번 확인해주세요');
                }   
            }


            function passwordCheck(event) {
                var pass1 = $('#password').val();
                var pass2 = $('#password_verify').val();
                if (pass1.trim() === '') {
                    alert('비밀번호를 입력해주세요');
                } else if (pass2.trim() === '') {
                    alert('재확인 비밀번호를 입력해주세요');
                }
                else if (pass1 === pass2) { // 비밀번호 확인 성공
                    isPassChecked = true;
                    togglePasswordModal();
                } else {
                    alert('비밀번호가 일치하지 않습니다.\n비밀번호를 확인 후 재시도해주세요.');
                }
            }

            function registerCheck(event) {
                //입력 확인
                var name = $('#name').val();
                var gender = $('#gender option:selected').val(); //선택된 성별 값 가져옴
                var birthY = $('#yy').val(); // 년도 4글자 입력 
                var birthM = $('#mm option:selected').val(); // 선택된 월
                var birthD = $('#dd').val(); // 일 최대 2글자 입력

                var isFilled = name.trim()!=='' && gender!=='성별' && birthY!=='' && birthM!=='월' && birthD!=='' ? true : false;

                // console.log('name:',name);
                // console.log('gender:',gender);
                // console.log('birthY:',birthY);
                // console.log('birthM:',birthM);
                // console.log('birthD:',birthD);
                // console.log('isFilled :', isFilled);

                if (!isAuthChecked) { // 이메일 인증 확인
                        alert('이메일 인증을 해주세요.');
                } else if (!isPassChecked) { // 비밀번호 입력 확인
                    alert('비밀번호 재확인을 해주세요');
                } else if (!isFilled) { // 모두 입력 되었는지 확인
                    alert('모든 회원가입 폼을 작성해주세요.');
                } else { // 모든 조건 만족해야 가입 성공
                    // 회원가입 양식 전송
                    $.ajax({
                            type:"POST",
                            async : true,
                            url:'/signup',
                            data : {
                                email: $('#email').val(),
                                password: $('#password').val(),
                                name : $('#name').val(),
                                birth : birthY+'.'+birthM+'.'+birthD+'.',
                                // promotion , // 이건 라우터에서 해줌
                            },
                            success:function(data){ // 이메일 전송 성공한 경우
                                console.log('가입 성공');
                                toggleRegisterModal();
                            }, 
                            error: function(err) { // POST 요청 실패시
                                console.log('가입 실패' + err);
                            }
                        });
                    
                }
            }

            function succeededRegister() { // 로그인 성공 팝업에서 [확인],[X]버튼 클릭시 로그인 페이지로 이동
                location.href = '/';
            }

            

            trigger_verify_fail.addEventListener("click", toggleFailModal);
            trigger_send_verify.addEventListener("click", sendAuthEmail);
            trigger_chk_verify.addEventListener("click", emailCheck);
            trigger_register.addEventListener("click", registerCheck);
            trigger_password.addEventListener("click", passwordCheck);

            confirmFailButton.addEventListener("click", toggleFailModal);
            confirmSendButton.addEventListener("click", toggleSendModal);
            confirmCheckButton.addEventListener("click", toggleCheckModal);
            confirmRegisterButton.addEventListener("click", succeededRegister); // 회원가입 성공 - 로그인 페이지로 이동
            confirmPasswordButton.addEventListener('click', togglePasswordModal);
            
            closeFailButton.addEventListener("click", toggleFailModal);
            closeSendButton.addEventListener("click", toggleSendModal);
            closeCheckButton.addEventListener("click", toggleCheckModal);
            closeRegisterButton.addEventListener("click", succeededRegister); // 회원가입 성공 - 로그인 페이지로 이동
            closePasswordButton.addEventListener('click', togglePasswordModal);

            window.addEventListener("click", windowOnClick);
        });
        </script>
    </div>
        
</body>
</html>